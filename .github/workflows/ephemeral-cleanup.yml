name: Cleanup Ephemeral Environment

on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  PROJECT_ID: tttc-light-js
  REGION: us-central1

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Delete Cloud Run services
      run: |
        PR_NUMBER=${{ github.event.number }}
        
        # Delete services (ignore errors if they don't exist)
        gcloud run services delete t3c-next-client-pr-${PR_NUMBER} --region=$REGION --quiet || echo "Frontend service not found"
        gcloud run services delete t3c-express-server-pr-${PR_NUMBER} --region=$REGION --quiet || echo "Backend service not found"
        gcloud run services delete pyserver-brandon-pr-${PR_NUMBER} --region=$REGION --quiet || echo "Python service not found"

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const pr_number = context.payload.pull_request.number;
          
          const comment = `ðŸ§¹ **Ephemeral Environment Cleaned Up**
          
          All Cloud Run services for PR #${pr_number} have been deleted.`;
          
          github.rest.issues.createComment({
            issue_number: pr_number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });