#!/bin/bash
echo "Running Biome on staged files..."

# Check and fix staged files
pnpm exec biome check --write --staged --no-errors-on-unmatched --files-ignore-unknown=true

# Re-stage any files that were modified
git update-index --again

echo "Biome check complete!"

# Run CodeScene if installed
if command -v cs &> /dev/null; then
  echo "Running CodeScene delta analysis..."
  if ! cs delta --staged; then
    echo ""
    echo "⚠️  CodeScene found code health issues (warning only, not blocking commit)"
  fi
  echo "CodeScene check complete!"
fi

# TypeScript check for changed packages
echo "Running TypeScript check on changed packages..."

CHANGED=""
git diff --cached --name-only | grep -q "^express-server/" && CHANGED="$CHANGED express-server"
git diff --cached --name-only | grep -q "^next-client/" && CHANGED="$CHANGED next-client"
git diff --cached --name-only | grep -q "^common/" && CHANGED="$CHANGED tttc-common"
git diff --cached --name-only | grep -q "^pipeline-worker/" && CHANGED="$CHANGED pipeline-worker"

if [ -n "$CHANGED" ]; then
  # Build common first if changed (other packages depend on it)
  if echo "$CHANGED" | grep -q "tttc-common"; then
    echo "Building tttc-common..."
    pnpm --filter=tttc-common run build || exit 1
  fi

  # Typecheck each changed package
  for pkg in $CHANGED; do
    echo "Typechecking $pkg..."
    pnpm --filter=$pkg exec tsc --noEmit || exit 1
  done
fi

echo "TypeScript check complete!"
